<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Report Details</title>
    <style>
        /* Add this to your existing styles */
        .status-control {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .status-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: inherit;
            cursor: pointer;
        }
        .status-new {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status-reviewed {
            background-color: #e8f5e9;
            color: #388e3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="admin.html" class="back-link">← Back to All Reports</a>
        </div>
        
        <div id="reportContent">
            <!-- Report content will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDcjqTdo23GdBhAbfyq6Mchlbs0ad5TO7U",
            authDomain: "accident-report-9b7ee.firebaseapp.com",
            projectId: "accident-report-9b7ee",
            storageBucket: "accident-report-9b7ee.firebasestorage.app",
            messagingSenderId: "644874177194",
            appId: "1:644874177194:web:647c19e7993b2194165ed3",
            measurementId: "G-TLHK07YWKG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get report ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');
        
        // Function to update status in Firestore
        function updateReportStatus(newStatus) {
            return db.collection('reports').doc(reportId).update({
                status: newStatus,
                reviewedAt: newStatus === 'reviewed' ? firebase.firestore.FieldValue.serverTimestamp() : null
            });
        }
        
        // Fetch the report from Firebase
        db.collection('reports').doc(reportId).get().then((doc) => {
            if (doc.exists) {
                const report = doc.data();
                const currentStatus = report.status || 'new';
                
                // Format the accident type for display
                const formattedAccidentType = {
                    'slip_trip': 'Slip/Trip/Fall',
                    'vehicle': 'Vehicle Accident',
                    'equipment': 'Equipment/Machinery',
                    'chemical': 'Chemical Exposure',
                    'other': 'Other'
                }[report.accidentType] || report.accidentType;
                
                // Format date
                const reportDate = report.reportDate ? 
                    new Date(report.reportDate).toLocaleDateString() : 'Not specified';
                
                // Create HTML for the report
                const reportHTML = `
                    <div class="report-header">
                        <h1>Accident Report Details</h1>
                        <span class="report-id">Report ID: ${reportId.substring(0, 8)}</span>
                    </div>
                    
                    <!-- Status Control -->
                    <div class="status-control">
                        <span class="status-label">Status:</span>
                        <select id="reportStatus" class="status-select status-${currentStatus}">
                            <option value="new" ${currentStatus === 'new' ? 'selected' : ''}>New</option>
                            <option value="reviewed" ${currentStatus === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                        </select>
                    </div>
                    
                    <div class="report-section">
                        <h2>Incident Information</h2>
                        <div class="report-field">
                            <strong>Date:</strong>
                            <div>${reportDate}</div>
                        </div>
                        <div class="report-field">
                            <strong>Time:</strong>
                            <div>${report.reportTime || 'Not specified'}</div>
                        </div>
                        <div class="report-field">
                            <strong>Location:</strong>
                            <div>${report.location || 'Not specified'}</div>
                        </div>
                        <div class="report-field">
                            <strong>Accident Type:</strong>
                            <div>${formattedAccidentType}</div>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h2>Incident Description</h2>
                        <div style="white-space: pre-line; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            ${report.description || 'No description provided'}
                        </div>
                    </div>
                    
                    ${report.injuries ? `
                    <div class="report-section">
                        <h2>Injuries Sustained</h2>
                        <div style="white-space: pre-line; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            ${report.injuries}
                        </div>
                    </div>` : ''}
                    
                    <div class="report-section">
                        <h2>Reporter Information</h2>
                        <div class="report-field">
                            <strong>Name:</strong>
                            <div>${report.reporterName || 'Not specified'}</div>
                        </div>
                        <div class="report-field">
                            <strong>Contact:</strong>
                            <div>${report.reporterContact || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    ${report.witnesses ? `
                    <div class="report-section">
                        <h2>Witness Information</h2>
                        <div style="white-space: pre-line; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            ${report.witnesses}
                        </div>
                    </div>` : ''}
                    
                    <div class="report-section">
                        <h2>Report Metadata</h2>
                        <div class="report-field">
                            <strong>Submitted On:</strong>
                            <div>${new Date(report.createdAt?.toDate()).toLocaleString()}</div>
                        </div>
                        ${report.reviewedAt ? `
                        <div class="report-field">
                            <strong>Reviewed On:</strong>
                            <div>${new Date(report.reviewedAt?.toDate()).toLocaleString()}</div>
                        </div>` : ''}
                    </div>
                    
                    <button class="print-btn" onclick="window.print()">Print Report</button>
                `;
                
                document.getElementById('reportContent').innerHTML = reportHTML;
                
                // Add event listener for status changes
                document.getElementById('reportStatus').addEventListener('change', function(e) {
                    const newStatus = e.target.value;
                    updateReportStatus(newStatus)
                        .then(() => {
                            e.target.className = `status-select status-${newStatus}`;
                        })
                        .catch(error => {
                            console.error("Error updating status:", error);
                            alert("Failed to update status. Please try again.");
                            e.target.value = currentStatus; // Revert on error
                        });
                });
                
            } else {
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-header">
                        <h1>Report Not Found</h1>
                    </div>
                    <p>The requested report could not be found. Please check the report ID and try again.</p>
                    <a href="admin.html" class="back-link">← Back to All Reports</a>
                `;
            }
        }).catch((error) => {
            console.error("Error getting document:", error);
            document.getElementById('reportContent').innerHTML = `
                <div class="report-header">
                    <h1>Error Loading Report</h1>
                </div>
                <p>There was an error loading the report. Please try again later.</p>
                <p>Error: ${error.message}</p>
                <a href="admin.html" class="back-link">← Back to All Reports</a>
            `;
        });
    </script>
</body>
</html>
